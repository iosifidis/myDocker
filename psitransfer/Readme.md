#### **1. Σκοπός**

Αυτός ο οδηγός περιγράφει τη διαδικασία εγκατάστασης της υπηρεσίας μεταφοράς αρχείων **PsiTransfer** σε ένα Docker container. Η πρόσβαση στην υπηρεσία θα γίνεται με ασφαλή τρόπο (HTTPS) μέσω ενός Caddy server που λειτουργεί ως reverse proxy.

Το σενάριο προϋποθέτει ότι ο Caddy server εκτελείται ήδη σε ένα ξεχωριστό container και είναι συνδεδεμένος σε ένα Docker network με το όνομα `web`.

#### **2. Προαπαιτούμενα**

1.  Ένας server με εγκατεστημένο **Docker** και **Docker Compose**.
2.  Ένας Caddy server που ήδη εκτελείται σε container και είναι συνδεδεμένος στο εξωτερικό δίκτυο `web`.
3.  Ένα όνομα χώρου (domain name) με μια εγγραφή DNS τύπου **A** που να δείχνει στη δημόσια IP διεύθυνση του server σας.

#### **3. Βήματα εγκατάστασης**

##### **Βήμα 1: Δημιουργία δομής φακέλων**

Αρχικά, θα δημιουργήσουμε έναν φάκελο για την υπηρεσία μας, ο οποίος θα περιέχει τα αρχεία ρυθμίσεων και τα δεδομένα της εφαρμογής.

Εκτελέστε τις παρακάτω εντολές:

```bash
# Δημιουργία του κεντρικού φακέλου του project
mkdir -p /docker/psitransfer

# Μετακίνηση στον νέο φάκελο
cd /docker/psitransfer

# Δημιουργία του φακέλου όπου θα αποθηκεύονται τα ανεβασμένα αρχεία
mkdir psitransfer_data

# Δημιουργία του αρχείου docker-compose.yml
touch docker-compose.yml
```

Μετά την εκτέλεση, η δομή των φακέλων σας θα πρέπει να είναι η εξής:
```
/docker/psitransfer/
├── docker-compose.yml
└── psitransfer_data/
```

##### **Βήμα 2: Παραμετροποίηση του Caddy (Caddyfile)**

Επεξεργαστείτε το **κεντρικό `Caddyfile`** του Caddy server σας (όπου κι αν αυτό βρίσκεται) και προσθέστε το παρακάτω μπλοκ κώδικα. Αυτό θα δώσει εντολή στον Caddy να προωθεί την κίνηση από το `transfer.sandbox.ellak.gr` στο container του PsiTransfer.

```caddy
# ===================================================
# Ρυθμίσεις για το PsiTransfer
# ===================================================
transfer.iosifidis.gr {
    # Προώθηση (reverse proxy) όλων των αιτήσεων στο container με όνομα 'psitransfer'
    # στην εσωτερική του θύρα, που είναι η 3000.
    # Η επικοινωνία γίνεται μέσω του κοινού δικτύου 'web'.
    reverse_proxy psitransfer:3000
}
```

Μετά την αποθήκευση του `Caddyfile`, **πρέπει να κάνετε επανεκκίνηση στον Caddy** για να εφαρμόσει τις νέες ρυθμίσεις:

```bash
# Αντικαταστήστε το 'caddy' με το πραγματικό όνομα του container σας αν είναι διαφορετικό
docker restart caddy
```

##### **Βήμα 3: Δημιουργία Αρχείου Docker Compose**

Τώρα, επεξεργαστείτε το αρχείο `docker-compose.yml` που δημιουργήσαμε στο `Βήμα 1` και προσθέστε το παρακάτω περιεχόμενο.

`docker-compose.yml`
```yaml
services:
  psitransfer:
    # Χρήση της επίσημης, σταθερής εικόνας του PsiTransfer
    image: psitrax/psitransfer
    
    # Ορισμός ενός σταθερού ονόματος για το container για εύκολη διαχείριση
    container_name: psitransfer
    
    # Αυτόματη επανεκκίνηση του container σε περίπτωση σφάλματος ή επανεκκίνησης του server
    restart: unless-stopped
    
    volumes:
      # Σύνδεση (mapping) του τοπικού φακέλου 'psitransfer_data' με τον φάκελο '/data' μέσα στο container.
      # Εδώ αποθηκεύονται όλα τα αρχεία που ανεβαίνουν οι χρήστες.
      - ./psitransfer_data:/data
      
    networks:
      # Σύνδεση του container στο δίκτυο 'web', ώστε ο Caddy να μπορεί να επικοινωνήσει μαζί του.
      - web
      
    # Μεταβλητές περιβάλλοντος για την παραμετροποίηση του PsiTransfer
    environment:
      # Ορίστε έναν ισχυρό κωδικό πρόσβασης για την περιοχή διαχείρισης
      - PSITRANSFER_ADMIN_PASS=YourSecurePasswordHere 
      
      # (Προαιρετικό) Αλλάξτε τον προεπιλεγμένο χρόνο διατήρησης αρχείων σε δευτερόλεπτα.
      # Π.χ., 86400 για 24 ώρες.
      # - PSITRANSFER_DEFAULT_RETENTION=86400

# Δήλωση ότι το δίκτυο 'web' είναι εξωτερικό και δεν πρέπει να δημιουργηθεί από αυτό το αρχείο.
networks:
  web:
    external: true
```

##### **Βήμα 4: Διόρθωση δικαιωμάτων φακέλου**

Το container του PsiTransfer εκτελείται εσωτερικά με έναν χρήστη που χρειάζεται δικαιώματα εγγραφής στον φάκελο που συνδέσαμε (`psitransfer_data`). Για να διασφαλίσουμε ότι η εφαρμογή μπορεί να αποθηκεύσει τα αρχεία, εκτελούμε την παρακάτω εντολή για να δώσουμε πλήρη δικαιώματα.

```bash
# Βεβαιωθείτε ότι βρίσκεστε στον φάκελο /docker/psitransfer
sudo chmod -R 777 psitransfer_data/
```

##### **Βήμα 5: Εκκίνηση της υπηρεσίας**

Είμαστε έτοιμοι να ξεκινήσουμε την υπηρεσία. Από τον φάκελο `/docker/psitransfer`, εκτελέστε την παρακάτω εντολή:

```bash
docker compose up -d
```

Η παράμετρος `-d` (detached) εκκινεί το container στο παρασκήνιο.

#### **4. Επαλήθευση**

Ανοίξτε τον browser σας και επισκεφθείτε τη διεύθυνση **`https://transfer.sandbox.ellak.gr`**. Θα πρέπει να δείτε την αρχική σελίδα του PsiTransfer, έτοιμη για χρήση. Δοκιμάστε να ανεβάσετε ένα μικρό αρχείο για να επιβεβαιώσετε ότι όλα λειτουργούν σωστά.

#### **5. Σύνοψη εντολών**

Ακολουθεί μια γρήγορη αναφορά όλων των εντολών που χρησιμοποιήθηκαν:

```bash
# 1. Δημιουργία δομής φακέλων
mkdir -p /docker/psitransfer
cd /docker/psitransfer
mkdir psitransfer_data
touch docker-compose.yml

# 2. Επανεκκίνηση Caddy (μετά την επεξεργασία του Caddyfile)
docker restart caddy

# 3. Ανάθεση δικαιωμάτων στον φάκελο δεδομένων
sudo chmod -R 777 psitransfer_data/

# 4. Εκκίνηση της υπηρεσίας PsiTransfer
docker compose up -d
```

#### **6. Αντιμετώπιση προβλημάτων**

Αν η υπηρεσία δεν λειτουργεί όπως αναμένεται, το πρώτο βήμα είναι να ελέγξετε τα logs του container.

```bash
# Εμφάνιση των τρεχόντων logs
docker logs psitransfer

# Παρακολούθηση των logs σε πραγματικό χρόνο (χρήσιμο κατά τη διάρκεια δοκιμών)
docker logs -f psitransfer
```

Αναζητήστε μηνύματα που περιέχουν τις λέξεις `Error` ή `Permission denied`.
